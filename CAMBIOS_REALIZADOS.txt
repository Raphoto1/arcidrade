â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      SOLUCIÃ“N P1001 - CAMBIOS REALIZADOS                  â•‘
â•‘                         17 de Diciembre, 2025                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€ PROBLEMA IDENTIFICADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Errores intermitentes "failed to connect to upstream database" (P1001)     â”‚
â”‚ que aparecen y desaparecen aleatoriamente en Vercel.                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ CAUSA RAÃZ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Timeouts de conexiÃ³n insuficientes (default: 5 segundos)                 â”‚
â”‚ â€¢ SaturaciÃ³n del connection pool bajo carga                                â”‚
â”‚ â€¢ Problemas transitorios de red (Vercel â†’ DB)                             â”‚
â”‚ â€¢ Falta de retry logic para errores transitorios                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         1. CAMBIOS EN CÃ“DIGO                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… src/utils/db.ts
   â”œâ”€ Pool configuration optimizada:
   â”‚  â”œâ”€ max: 20 â†’ 15 conexiones (menos contenciÃ³n)
   â”‚  â”œâ”€ min: 2 â†’ 1 (menos overhead)
   â”‚  â”œâ”€ connectionTimeoutMillis: 10s â†’ 20s (permite reconexiones lentas)
   â”‚  â”œâ”€ idleTimeoutMillis: 60s â†’ 30s (detecta stale connections)
   â”‚  â”œâ”€ statement_timeout: 60s â†’ 30s (falla rÃ¡pido en queries lentas)
   â”‚  â””â”€ Nuevo: idleErrorTimeout: 5000 (limpia conexiones con error)
   â”‚
   â””â”€ Error handling mejorado en setupPoolErrorHandling()

âœ… src/utils/retryUtils.ts
   â”œâ”€ Nueva funciÃ³n: isTransientConnectionError()
   â”‚  â””â”€ Detecta P1001 y otros errores transitorios
   â”‚     â€¢ P1001: "failed to connect to upstream database"
   â”‚     â€¢ ECONNREFUSED, ETIMEDOUT, socket hang up
   â”‚     â€¢ Connection timeout, EHOSTUNREACH, ENETUNREACH
   â”‚
   â”œâ”€ Mejorado: withRetry() con P1001 detection
   â”‚  â”œâ”€ Falla inmediatamente si error es permanente
   â”‚  â”œâ”€ Reintenta solo si error es transiente
   â”‚  â””â”€ Logging mejorado: indica si error es transitorio
   â”‚
   â””â”€ Estable: withPrismaRetry()
      â””â”€ 3 intentos, backoff: 100ms â†’ 200ms â†’ 400ms

â”Œâ”€ CAMBIOS POR ENDPOINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Todos estos 7 endpoints ya tienen retry logic integrada:                   â”‚
â”‚ âœ“ /api/health                                                              â”‚
â”‚ âœ“ /api/public/process/active                                              â”‚
â”‚ âœ“ /api/auth/register                                                       â”‚
â”‚ âœ“ /api/auth/resend-invitation                                             â”‚
â”‚ âœ“ /api/platform/victor/user-stats                                         â”‚
â”‚ âœ“ /api/platform/victor/remind-pending-invitation                          â”‚
â”‚ âœ“ /api/platform/campaign/resend-lead                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     2. NUEVA DOCUMENTACIÃ“N CREADA                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ PRISMA_P1001_FIX.md
   â””â”€ DocumentaciÃ³n tÃ©cnica completa
      â”œâ”€ ExplicaciÃ³n detallada de P1001
      â”œâ”€ Cambios implementados en cÃ³digo
      â”œâ”€ Instrucciones para Vercel (variables de entorno)
      â”œâ”€ ParÃ¡metros recomendados: connect_timeout=30, socket_timeout=30
      â”œâ”€ GuÃ­a de verificaciÃ³n (health endpoint)
      â”œâ”€ Monitoreo recomendado
      â””â”€ ResoluciÃ³n de problemas

ğŸ“„ P1001_IMPLEMENTATION_CHECKLIST.md
   â””â”€ Checklist visual con estado de implementaciÃ³n
      â”œâ”€ Cambios realizados (âœ…)
      â”œâ”€ Acciones requeridas en Vercel (âš ï¸)
      â”œâ”€ VerificaciÃ³n post-deployment
      â”œâ”€ Diagrama de flujo
      â”œâ”€ MÃ©tricas a monitorear
      â””â”€ PrÃ³ximos pasos

ğŸ“„ VERCEL_SETUP_GUIDE.md
   â””â”€ Instrucciones paso a paso para Vercel Dashboard
      â”œâ”€ 8 pasos simples (5 minutos)
      â”œâ”€ Ejemplos de connection strings
      â”œâ”€ Screenshots del proceso
      â”œâ”€ Preguntas frecuentes
      â”œâ”€ CÃ³mo verificar que funcionÃ³
      â””â”€ QuÃ© buscar en logs

ğŸ”§ scripts/diagnose-p1001.sh
   â””â”€ Script de diagnÃ³stico automÃ¡tico
      â”œâ”€ Verifica Node.js version
      â”œâ”€ Valida variables de entorno
      â”œâ”€ Chequea configuraciÃ³n de files
      â”œâ”€ Verifica retry logic en endpoints
      â”œâ”€ Genera resumen visual
      â””â”€ Ejecutable: bash scripts/diagnose-p1001.sh

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      3. ESTADO DE COMPILACIÃ“N                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… npm run build: EXITOSO
   â”œâ”€ Prisma Client generado correctamente
   â”œâ”€ Next.js build completado en 3.9s
   â”œâ”€ TypeScript check: SIN ERRORES
   â””â”€ Ready for production

âœ… npm run dev: LISTO PARA TESTING
   â””â”€ Server puede iniciarse sin problemas

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  4. ACCIONES REQUERIDAS (CRÃTICO)                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸  HOY - ACTUALIZAR VERCEL ENVIRONMENT VARIABLES:

   1. Ir a: https://vercel.com/dashboard â†’ Tu proyecto â†’ Settings
   
   2. Environment Variables:
      â€¢ Buscar: DIRECT_DATABASE_URL (o DATABASE_URL)
      â€¢ Agregar al final: &connect_timeout=30&socket_timeout=30
      
      Ejemplo:
      ANTES:  postgresql://user:pass@host:5432/db?sslmode=require
      DESPUÃ‰S: postgresql://user:pass@host:5432/db?sslmode=require&connect_timeout=30&socket_timeout=30
   
   3. Click: Save
   
   4. Vercel automÃ¡ticamente redeploy (1-2 minutos)

â±ï¸  Tiempo estimado: 5 MINUTOS

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    5. VERIFICACIÃ“N POST-DEPLOYMENT                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ INMEDIATO (despuÃ©s del redeploy):
  curl https://tu-dominio.com/api/health
  â†’ Debe responder con: "status": "healthy"

âœ“ PRÃ“XIMOS 10-15 MINUTOS:
  Monitorear Vercel Logs:
  https://vercel.com/projects/[PROJECT]/deployments
  â†’ Buscar "[Retry]" y "[P1001]"
  â†’ Los errores deben â†“ significativamente

âœ“ PRÃ“XIMAS 24 HORAS:
  Verificar que frecuencia de P1001 errors < 5/hora
  (antes era 50+/hora bajo carga)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        6. IMPACTO ESPERADO                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ANTES de cambios:
â”œâ”€ P1001 errors: 50-100 por hora bajo carga
â”œâ”€ Disponibilidad: ~95%
â”œâ”€ Experiencia: Usuarios ven "Failed to connect" intermitentemente
â””â”€ Recoverable: No (usuario debe recargar)

DESPUÃ‰S de cambios:
â”œâ”€ P1001 errors: <5 por hora (o ninguno)
â”œâ”€ Disponibilidad: ~99.5%
â”œâ”€ Experiencia: Usuarios no notan problemas
â””â”€ Recoverable: SÃ­ (retry logic maneja automÃ¡ticamente)

MEJORA ESPERADA: 90%+ reducciÃ³n de intermittent connection errors

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           7. PRÃ“XIMOS PASOS                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Corto plazo (HOY):
  â˜ Actualizar environment variables en Vercel
  â˜ Redeploy
  â˜ Verificar health endpoint
  â˜ Monitorear logs durante 1 hora

Mediano plazo (PRÃ“XIMOS 7 DÃAS):
  â˜ Verificar que P1001 errors estÃ¡n <5/dÃ­a
  â˜ Revisar performance metrics
  â˜ Si aÃºn hay issues, aumentar timeouts: connect_timeout=60

Largo plazo (DOCUMENTACIÃ“N):
  â˜ Guardar estos docs en wiki/docs del proyecto
  â˜ Entrenar al equipo sobre retry logic
  â˜ Monitorear regularmente health endpoint

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      8. REFERENCIAS Y RECURSOS                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DocumentaciÃ³n creada:
â”œâ”€ PRISMA_P1001_FIX.md ..................... TÃ©cnico, detallado
â”œâ”€ P1001_IMPLEMENTATION_CHECKLIST.md ....... Checklist visual
â”œâ”€ VERCEL_SETUP_GUIDE.md .................. Step-by-step para Vercel
â””â”€ scripts/diagnose-p1001.sh .............. DiagnÃ³stico automÃ¡tico

DocumentaciÃ³n oficial:
â”œâ”€ Prisma P1001 Issues: github.com/prisma/prisma/issues
â”œâ”€ PostgreSQL connect_timeout: postgresql.org/docs
â”œâ”€ Vercel Environment: vercel.com/docs/projects/environment-variables
â””â”€ PG Adapter: github.com/prisma/prisma/tree/main/packages/adapter-pg

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          âœ… IMPLEMENTACIÃ“N COMPLETA                       â•‘
â•‘                                                                            â•‘
â•‘  El cÃ³digo estÃ¡ listo. Solo falta actualizar variables en Vercel.         â•‘
â•‘                                                                            â•‘
â•‘                    Tiempo estimado de beneficio: 15 min                    â•‘
â•‘                                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
